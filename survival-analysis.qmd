---
format:
  html:
    number-depth: 3
    css: summary-format.css
---
# Survival Analysis and Censored Data

## General concepts

In this models the outcome variable is the **time until an event occurs** or any other numeric variable have been **censored** by any limitation during data collection.

- **Survival, failure or event time** $T$: Represents the time at which the event of interest occurs. For instance, the time at which the *patient dies* or the *customer cancels his or her subscription*.
- **Censoring time** $C$: Represents the time at which censoring occurs. For example, the time at which the patient *drops out of the study* or the *study ends*.

As result our target variable is the result of:

$$
Y = \min(T, C)
$$

To know how to interpret the results we will need an indicator:

$$
\delta = 
 \begin{cases}
   1 & \quad \text{if } T \leq C \\
   0 & \quad \text{if } T > C
 \end{cases}
$$

As result when $\delta = 1$ we observe the true survival time, and when $\delta = 0$ if we observe the censoring time.In the next example, we just could observe the event for patients 1 and 3 before ending the study.

![](img/55-censored-survival-example.png){fig-align="center"}

### Assumptions

In order to analyze survival data, we need to determine whether the following assumptions are reasonable:

- The **event time** $T$ **is independent of the censoring time** $C$. For example, *patients drop out of the cancer study early because they are very sick*, that would **overestimate** the true average survival time. We can check this assumption by exploring the ***reasons related to dropouts***.

- The **predictors are independent of the censoring event** $\delta = 0$. For example, if in our study *very sick males are more likely to drop out of the study than very sick females*, that would drive the **wrong conclusion** that males survive longer than females.

### Censoring types

1. **Right censoring**: It occurs when $T \geq Y$, i.e. the true event time $T$ is at least as large as the observed time $Y$.
2. **Left censoring**: It occurs when $T \leq Y$, i.e. the true event time $T$ is less than or equal to the observed time $Y$.
3. **Interval censoring**: It refers to the setting in which we do not know the exact event time, but we know that it falls in some interval.

*Right censoring will be the main focus of this chapter.*

## Kaplan-Meier Survival Curve

The **survival curve (function)** is defined as the probability that the *event time* $T$ happens later than a time $t$. As result, *the larger the value of *$S(t)$*, the less likely that the event would take place before time* $t$. 

$$
S(t) = \Pr(T > t)
$$

To explain how complicated can be to estimate $S(20) = \Pr(T>20)$ when our target variable is a mix of event and censored times we will use the `ISLR2::BrainCancer` table as a example.

```{r}
pillar::glimpse(ISLR2::BrainCancer)

data.table::as.data.table(ISLR2::BrainCancer) |>
  (\(DT) DT[, .N,
            keyby = .(alive_20_months = time > 20,
                      event_time = status)])()
  
```

- Taking the total of patients who were alive after 20 months ($36+12=48$) over the total number of patients ($48/88 \approx 55\%$) would be a mistake as we cannot assume that $T < 20$ for $17$ censored patients.

- Omitting the $17$ censored patients might sound as solution but that would **under estimate** the probability as a patient who was censored at $t = 19.9$ likely would have survived past $t = 20$, and would be better to take a advantage of that censored time.

To overcome this challenge let's define:

- $d_1 < d_2 < \dots < d_K$: The $K$ unique death times among the non-censored patients.
- $q_k$: The number of patients who died at time $d_k$.
- $r_k$: The number of patients alive and in the study just before $d_k$, *at risk patients*.
- $\widehat{\Pr}(T > d_j|T > d_{j-1}) = (r_j - q_j) / r_j$: It estimates the fraction of the risk set at time $d_j$ who survived past time $d_j$.

*And based on the law of total probability*

$$
\begin{split}
\Pr(T > d_k) = & \Pr(T > d_k|T > d_{k-1}) \Pr(T > d_{k-1}) + \\
               & \Pr(T > d_k|T \leq d_{k-1}) \Pr(T \leq d_{k-1})
\end{split}
$$

But as it is impossible for a patient to survive past time $d_k$ if he or she did not survive until an earlier time $d_{kâˆ’1}$, we know that $\Pr(T > d_k|T \leq d_{k-1}) = 0$ and we can simplify the function and found out that this a recurrent function.

$$
\begin{split}
\Pr(T > d_k) = & \Pr(T > d_k|T > d_{k-1}) \Pr(T > d_{k-1}) \\
S(d_k) = & \Pr(T > d_k|T > d_{k-1}) \times \dots \times \Pr(T > d_2|T > d_1) \Pr(T > d_1) \\
\hat{S}(d_k) = & \prod_{j=1}^k \left( \frac{r_j - q_j}{r_j} \right)
\end{split}
$$

As we can see the the example below, the **Kaplan-Meier survival curve** has a step-like shape as we assume that $\hat{S}(t) = \hat{S}(d_k)$ when $d_k < t < d_{k+1}$.

![](img/56-Kaplan-Meier-survival-curve.png){fig-align="center"}

*Based on this new function we can say that the probability of survival past 20 months is* $71\%$.
